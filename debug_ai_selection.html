<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Selection Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #45a049;
        }
        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>AI Selection Debug Test</h1>
    
    <div class="debug-panel">
        <h2>Test AI Detection Logic</h2>
        <button class="test-button" onclick="testAIDetection()">Test AI Detection</button>
        <button class="test-button" onclick="testHumanTeamsSetup()">Test Human Teams Setup</button>
        <button class="test-button" onclick="testPlayerInitialization()">Test Player Initialization</button>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="debug-panel">
        <h2>Modal State Simulation</h2>
        <button class="test-button" onclick="simulateModalOpen()">Simulate Modal Open</button>
        <button class="test-button" onclick="simulateModalClose()">Simulate Modal Close</button>
        <button class="test-button" onclick="checkModalState()">Check Modal State</button>
    </div>
    
    <div class="debug-panel">
        <h2>Debug Output</h2>
        <div id="logOutput" class="log-output"></div>
    </div>

    <script>
        // Initialize modal state tracking
        window.modalState = 'closed';
        
        // Mock game data structures
        let players = [];
        let humanTeams = new Set();
        let losers = [];
        let currentLoserIndex = 0;
        
        function log(message) {
            const output = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logOutput').textContent = '';
        }
        
        function testAIDetection() {
            log('ðŸ§ª Testing AI Detection Logic...');
            
            // Test scenario 1: 2-player game with wolf as AI
            players = [
                { name: 'rabbit', obj: {}, isHuman: true },
                { name: 'wolf', obj: {}, isHuman: false }
            ];
            humanTeams = new Set(['rabbit']);
            
            log('Scenario 1: 2-player game, rabbit=human, wolf=AI');
            log(`Players: ${JSON.stringify(players.map(p => ({name: p.name, isHuman: p.isHuman})))}`);
            log(`Human Teams: ${JSON.stringify(Array.from(humanTeams))}`);
            
            // Test AI detection for each player
            players.forEach(player => {
                const isHumanByProperty = player.isHuman;
                const isHumanBySet = humanTeams.has(player.name);
                const isHumanLoser = isHumanByProperty || isHumanBySet;
                
                log(`${player.name}: isHuman=${isHumanByProperty}, inHumanTeams=${isHumanBySet}, isHumanLoser=${isHumanLoser}`);
            });
            
            // Test scenario 2: Players without isHuman property (common issue)
            log('\nScenario 2: Players without isHuman property');
            players = [
                { name: 'rabbit', obj: {} },
                { name: 'wolf', obj: {} }
            ];
            humanTeams = new Set(['rabbit']);
            
            log(`Players: ${JSON.stringify(players.map(p => ({name: p.name, isHuman: p.isHuman})))}`);
            log(`Human Teams: ${JSON.stringify(Array.from(humanTeams))}`);
            
            players.forEach(player => {
                const isHumanByProperty = player.isHuman;
                const isHumanBySet = humanTeams.has(player.name);
                const isHumanLoser = isHumanByProperty || isHumanBySet;
                
                log(`${player.name}: isHuman=${isHumanByProperty}, inHumanTeams=${isHumanBySet}, isHumanLoser=${isHumanLoser}`);
            });
        }
        
        function testHumanTeamsSetup() {
            log('ðŸ§ª Testing Human Teams Setup...');
            
            // Simulate the game setup process
            const numHumanTeams = 1;
            humanTeams.clear();
            
            log(`Number of human teams: ${numHumanTeams}`);
            log(`Human teams after clear: ${JSON.stringify(Array.from(humanTeams))}`);
            
            // Simulate user selecting rabbit as human
            humanTeams.add('rabbit');
            log(`After adding rabbit: ${JSON.stringify(Array.from(humanTeams))}`);
            log(`Human teams size: ${humanTeams.size}`);
            log(`Size matches numHumanTeams: ${humanTeams.size === numHumanTeams}`);
        }
        
        function testPlayerInitialization() {
            log('ðŸ§ª Testing Player Initialization...');
            
            // Simulate setupPlayers(2)
            players = [
                { name: 'rabbit', obj: {} },
                { name: 'wolf', obj: {} }
            ];
            
            log('After setupPlayers(2):');
            log(`Players: ${JSON.stringify(players.map(p => ({name: p.name, isHuman: p.isHuman})))}`);
            
            // Simulate applyHumanAIAssignments()
            humanTeams = new Set(['rabbit']);
            const set = new Set(humanTeams);
            players = players.map(p => ({ ...p, isHuman: set.has(p.name) }));
            
            log('After applyHumanAIAssignments():');
            log(`Players: ${JSON.stringify(players.map(p => ({name: p.name, isHuman: p.isHuman})))}`);
            log(`Human Teams: ${JSON.stringify(Array.from(humanTeams))}`);
            
            // Test the actual AI detection logic from the game
            losers = ['wolf'];
            currentLoserIndex = 0;
            const currentLoser = losers[currentLoserIndex];
            const loserPlayer = players.find(p => p.name === currentLoser);
            const isHumanLoser = (loserPlayer?.isHuman) || humanTeams.has(currentLoser);
            
            log(`\nAI Auto-Selection Test:`);
            log(`Current loser: ${currentLoser}`);
            log(`Loser player: ${JSON.stringify(loserPlayer)}`);
            log(`Is human by property: ${loserPlayer?.isHuman}`);
            log(`Is human by set: ${humanTeams.has(currentLoser)}`);
            log(`Is human loser: ${isHumanLoser}`);
            log(`Should AI auto-select: ${!isHumanLoser}`);
        }
        
        function simulateModalOpen() {
            log('ðŸ§ª Simulating Modal Open...');
            window.modalState = 'opening';
            log(`Modal state: ${window.modalState}`);
            
            setTimeout(() => {
                window.modalState = 'open';
                log(`Modal state after transition: ${window.modalState}`);
            }, 300);
        }
        
        function simulateModalClose() {
            log('ðŸ§ª Simulating Modal Close...');
            window.modalState = 'closing';
            log(`Modal state: ${window.modalState}`);
            
            setTimeout(() => {
                window.modalState = 'closed';
                log(`Modal state after transition: ${window.modalState}`);
                
                // Simulate the modalClosed event
                window.dispatchEvent(new CustomEvent('modalClosed', { 
                    detail: { timestamp: Date.now() } 
                }));
                log('Dispatched modalClosed event');
            }, 300);
        }
        
        function checkModalState() {
            log(`ðŸ§ª Current modal state: ${window.modalState}`);
        }
        
        // Listen for modal closed events
        window.addEventListener('modalClosed', (event) => {
            log(`ðŸŽ‰ Received modalClosed event: ${JSON.stringify(event.detail)}`);
        });
        
        log('ðŸš€ AI Selection Debug Test initialized');
        log('Click the test buttons above to run various debugging scenarios');
    </script>
</body>
</html>