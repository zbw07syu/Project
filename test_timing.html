<!DOCTYPE html>
<html>
<head>
    <title>RunRunRabbit Timing Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>RunRunRabbit AI Wolf Modal Race Condition Test</h1>
    
    <div>
        <button onclick="testModalTiming()">Test Modal Timing</button>
        <button onclick="testAIScheduling()">Test AI Scheduling</button>
        <button onclick="testRaceCondition()">Test Race Condition</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="logs"></div>

    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            logCount = 0;
        }
        
        // Simulate the modal callback timing
        function testModalTiming() {
            log('🧪 Testing modal callback timing...', 'info');
            
            // Simulate modal close
            log('📱 Modal closing...', 'info');
            
            // Modal closed event (50ms delay)
            setTimeout(() => {
                log('🔔 Modal closed event dispatched', 'success');
                window.dispatchEvent(new CustomEvent('modalClosed', { 
                    detail: { timestamp: Date.now() } 
                }));
            }, 50);
            
            // Modal callback (100ms delay)
            setTimeout(() => {
                log('📞 Modal callback executed', 'warning');
                // This would call handleOptionSelect
            }, 100);
        }
        
        // Simulate AI scheduling timing
        function testAIScheduling() {
            log('🧪 Testing AI scheduling timing...', 'info');
            
            // Simulate dice phase transition
            log('🎲 Transitioning to dice phase...', 'info');
            
            // AI scheduling (400ms delay)
            setTimeout(() => {
                log('🤖 AI auto-roll scheduled timeout triggered', 'success');
            }, 400);
        }
        
        // Test the race condition scenario
        function testRaceCondition() {
            log('🧪 Testing race condition scenario...', 'info');
            
            let aiActionInProgress = false;
            let pendingAIPlayer = null;
            let modalCallbackExecuted = false;
            let aiSchedulingExecuted = false;
            
            // Simulate modal close sequence
            log('📱 Modal closing with AI wolf waiting...', 'info');
            
            // Modal closed event (50ms)
            setTimeout(() => {
                log('🔔 Modal closed event - checking for pending AI', 'info');
                if (pendingAIPlayer && !aiActionInProgress) {
                    setTimeout(() => {
                        log('🤖 Modal event handler: Processing pending AI player', 'success');
                        // This would call maybeAutoRollIfAI
                    }, 200);
                }
            }, 50);
            
            // Modal callback (100ms)
            setTimeout(() => {
                log('📞 Modal callback: Executing handleOptionSelect', 'warning');
                modalCallbackExecuted = true;
                
                // This might trigger showNextOrEnd and eventually dice phase transition
                setTimeout(() => {
                    log('🔄 Modal callback triggered dice phase transition', 'warning');
                }, 50);
            }, 100);
            
            // AI scheduling from dice phase (400ms)
            setTimeout(() => {
                log('🤖 AI scheduling: Timeout triggered', 'info');
                aiSchedulingExecuted = true;
                
                if (modalCallbackExecuted) {
                    log('✅ Modal callback completed before AI scheduling - GOOD', 'success');
                } else {
                    log('❌ AI scheduling triggered before modal callback - POTENTIAL RACE', 'error');
                }
                
                // Check if modal is still open
                const modalOpen = false; // Simulate modal closed
                if (modalOpen) {
                    log('🤖 Modal still open, setting as pending player', 'warning');
                    pendingAIPlayer = { name: 'wolf' };
                } else {
                    log('🤖 Modal closed, proceeding with AI roll', 'success');
                }
            }, 400);
            
            // Summary after all timeouts
            setTimeout(() => {
                log('📊 Race condition test completed', 'info');
                log(`Modal callback executed: ${modalCallbackExecuted}`, modalCallbackExecuted ? 'success' : 'error');
                log(`AI scheduling executed: ${aiSchedulingExecuted}`, aiSchedulingExecuted ? 'success' : 'error');
            }, 500);
        }
        
        // Listen for modal closed events
        window.addEventListener('modalClosed', () => {
            log('🎧 Event listener: Modal closed event received', 'success');
        });
        
        log('🚀 Test page loaded. Click buttons to test different scenarios.', 'info');
    </script>
</body>
</html>